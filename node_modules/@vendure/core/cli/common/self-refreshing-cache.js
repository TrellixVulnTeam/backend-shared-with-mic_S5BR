"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createSelfRefreshingCache = void 0;
const vendure_logger_1 = require("../config/logger/vendure-logger");
async function createSelfRefreshingCache(config) {
    const { ttl, name, refresh, getTimeFn } = config;
    const getTimeNow = getTimeFn !== null && getTimeFn !== void 0 ? getTimeFn : (() => new Date().getTime());
    const initialValue = await refresh.fn(...refresh.defaultArgs);
    let value = initialValue;
    let expires = getTimeNow() + ttl;
    const memoCache = new Map();
    const refreshValue = (resetMemoCache = true, args) => {
        return refresh
            .fn(...args)
            .then(newValue => {
            value = newValue;
            expires = getTimeNow() + ttl;
            if (resetMemoCache) {
                memoCache.clear();
            }
            return value;
        })
            .catch(err => {
            vendure_logger_1.Logger.error(`Failed to update SelfRefreshingCache "${name}": ${err.message}`, undefined, err.stack);
            return value;
        });
    };
    const getValue = async (refreshArgs, resetMemoCache = true) => {
        const now = getTimeNow();
        if (expires < now) {
            return refreshValue(resetMemoCache, refreshArgs !== null && refreshArgs !== void 0 ? refreshArgs : refresh.defaultArgs);
        }
        return value;
    };
    const memoize = async (args, refreshArgs, fn) => {
        const key = JSON.stringify(args);
        const cached = memoCache.get(key);
        const now = getTimeNow();
        if (cached && now < cached.expires) {
            return cached.value;
        }
        const result = getValue(refreshArgs, false).then(val => fn(val, ...args));
        memoCache.set(key, {
            expires: now + ttl,
            value: result,
        });
        return result;
    };
    return {
        value: getValue,
        refresh: (...args) => refreshValue(true, args),
        memoize,
    };
}
exports.createSelfRefreshingCache = createSelfRefreshingCache;
//# sourceMappingURL=self-refreshing-cache.js.map