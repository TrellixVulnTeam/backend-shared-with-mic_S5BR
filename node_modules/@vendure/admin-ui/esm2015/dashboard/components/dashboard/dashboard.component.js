import { ChangeDetectionStrategy, ChangeDetectorRef, Component } from '@angular/core';
import { DashboardWidgetService, DataService, LocalStorageService, } from '@vendure/admin-ui/core';
import { assertNever } from '@vendure/common/lib/shared-utils';
import { map, tap } from 'rxjs/operators';
export class DashboardComponent {
    constructor(dashboardWidgetService, localStorageService, changedDetectorRef, dataService) {
        this.dashboardWidgetService = dashboardWidgetService;
        this.localStorageService = localStorageService;
        this.changedDetectorRef = changedDetectorRef;
        this.dataService = dataService;
        this.deletionMarker = '__delete__';
    }
    ngOnInit() {
        this.availableWidgetIds$ = this.dataService.client.userStatus().stream$.pipe(map(({ userStatus }) => userStatus.permissions), map(permissions => this.dashboardWidgetService.getAvailableIds(permissions)), tap(ids => (this.widgetLayout = this.initLayout(ids))));
    }
    getClassForWidth(width) {
        switch (width) {
            case 3:
                return `clr-col-12 clr-col-sm-6 clr-col-lg-3`;
            case 4:
                return `clr-col-12 clr-col-sm-6 clr-col-lg-4`;
            case 6:
                return `clr-col-12 clr-col-lg-6`;
            case 8:
                return `clr-col-12 clr-col-lg-8`;
            case 12:
                return `clr-col-12`;
            default:
                assertNever(width);
        }
    }
    getSupportedWidths(config) {
        return config.supportedWidths || [3, 4, 6, 8, 12];
    }
    setWidgetWidth(widget, width) {
        widget.width = width;
        this.recalculateLayout();
    }
    trackRow(index, row) {
        const id = row.map(item => `${item.id}:${item.width}`).join('|');
        return id;
    }
    trackRowItem(index, item) {
        return item.config;
    }
    addWidget(id) {
        var _a;
        const config = this.dashboardWidgetService.getWidgetById(id);
        if (config) {
            const width = this.getSupportedWidths(config)[0];
            const widget = {
                id,
                config,
                width,
            };
            let targetRow;
            if (this.widgetLayout && this.widgetLayout.length) {
                targetRow = this.widgetLayout[this.widgetLayout.length - 1];
            }
            else {
                targetRow = [];
                (_a = this.widgetLayout) === null || _a === void 0 ? void 0 : _a.push(targetRow);
            }
            targetRow.push(widget);
            this.recalculateLayout();
        }
    }
    removeWidget(widget) {
        widget.id = this.deletionMarker;
        this.recalculateLayout();
    }
    drop(event) {
        const { currentIndex, previousIndex, previousContainer, container } = event;
        if (previousIndex === currentIndex && previousContainer.data.index === container.data.index) {
            // Nothing changed
            return;
        }
        if (this.widgetLayout) {
            const previousLayoutRow = this.widgetLayout[previousContainer.data.index];
            const newLayoutRow = this.widgetLayout[container.data.index];
            previousLayoutRow.splice(previousIndex, 1);
            newLayoutRow.splice(currentIndex, 0, event.item.data);
            this.recalculateLayout();
        }
    }
    initLayout(availableIds) {
        const savedLayoutDef = this.localStorageService.get('dashboardWidgetLayout');
        let layoutDef;
        if (savedLayoutDef) {
            // validate all the IDs from the saved layout are still available
            layoutDef = savedLayoutDef.filter(item => availableIds.includes(item.id));
        }
        return this.dashboardWidgetService.getWidgetLayout(layoutDef);
    }
    recalculateLayout() {
        if (this.widgetLayout) {
            const flattened = this.widgetLayout
                .reduce((flat, row) => [...flat, ...row], [])
                .filter(item => item.id !== this.deletionMarker);
            const newLayoutDef = flattened.map(item => ({
                id: item.id,
                width: item.width,
            }));
            this.widgetLayout = this.dashboardWidgetService.getWidgetLayout(newLayoutDef);
            this.localStorageService.set('dashboardWidgetLayout', newLayoutDef);
            setTimeout(() => this.changedDetectorRef.markForCheck());
        }
    }
}
DashboardComponent.decorators = [
    { type: Component, args: [{
                selector: 'vdr-dashboard',
                template: "<div class=\"widget-header\">\r\n    <vdr-dropdown>\r\n        <button class=\"btn btn-secondary btn-sm\" vdrDropdownTrigger>\r\n            <clr-icon shape=\"plus\"></clr-icon>\r\n            {{ 'dashboard.add-widget' | translate }}\r\n        </button>\r\n        <vdr-dropdown-menu vdrPosition=\"bottom-right\">\r\n            <button\r\n                class=\"button\"\r\n                vdrDropdownItem\r\n                *ngFor=\"let id of availableWidgetIds$ | async\"\r\n                (click)=\"addWidget(id)\"\r\n            >\r\n                {{ id }}\r\n            </button>\r\n        </vdr-dropdown-menu>\r\n    </vdr-dropdown>\r\n</div>\r\n<div cdkDropListGroup>\r\n    <div\r\n        class=\"clr-row dashboard-row\"\r\n        *ngFor=\"let row of widgetLayout; index as rowIndex; trackBy: trackRow\"\r\n        cdkDropList\r\n        (cdkDropListDropped)=\"drop($event)\"\r\n        cdkDropListOrientation=\"horizontal\"\r\n        [cdkDropListData]=\"{ index: rowIndex }\"\r\n    >\r\n        <div\r\n            *ngFor=\"let widget of row; trackBy: trackRowItem\"\r\n            class=\"dashboard-item\"\r\n            [ngClass]=\"getClassForWidth(widget.width)\"\r\n            cdkDrag\r\n            [cdkDragData]=\"widget\"\r\n        >\r\n            <vdr-dashboard-widget\r\n                *vdrIfPermissions=\"widget.config.requiresPermissions || null\"\r\n                [widgetConfig]=\"widget.config\"\r\n            >\r\n                <div class=\"flex\">\r\n                    <div class=\"drag-handle\" cdkDragHandle>\r\n                        <clr-icon shape=\"drag-handle\" size=\"24\"></clr-icon>\r\n                    </div>\r\n                    <vdr-dropdown>\r\n                        <button class=\"icon-button\" vdrDropdownTrigger>\r\n                            <clr-icon shape=\"ellipsis-vertical\"></clr-icon>\r\n                        </button>\r\n                        <vdr-dropdown-menu vdrPosition=\"bottom-right\">\r\n                            <h4 class=\"dropdown-header\">{{ 'dashboard.widget-resize' | translate }}</h4>\r\n                            <button\r\n                                class=\"button\"\r\n                                vdrDropdownItem\r\n                                [disabled]=\"width === widget.width\"\r\n                                *ngFor=\"let width of getSupportedWidths(widget.config)\"\r\n                                (click)=\"setWidgetWidth(widget, width)\"\r\n                            >\r\n                                {{ 'dashboard.widget-width' | translate: { width: width } }}\r\n                            </button>\r\n                            <div class=\"dropdown-divider\" role=\"separator\"></div>\r\n                            <button class=\"button\" vdrDropdownItem (click)=\"removeWidget(widget)\">\r\n                                <clr-icon shape=\"trash\" class=\"is-danger\"></clr-icon>\r\n                                {{ 'dashboard.remove-widget' | translate }}\r\n                            </button>\r\n                        </vdr-dropdown-menu>\r\n                    </vdr-dropdown>\r\n                </div>\r\n            </vdr-dashboard-widget>\r\n        </div>\r\n    </div>\r\n</div>\r\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".widget-header{display:flex;justify-content:flex-end}.placeholder{color:var(--color-grey-300);text-align:center}.placeholder .version{font-size:3em;margin:24px;line-height:1em}.placeholder ::ng-deep .clr-i-outline{fill:var(--color-grey-200)}vdr-dashboard-widget{margin-bottom:24px}.cdk-drag-preview{box-sizing:border-box;border-radius:4px}.cdk-drag-placeholder{opacity:0}.cdk-drag-animating{transition:transform .25s cubic-bezier(0,0,.2,1)}.dashboard-row{padding:0;border-width:1;margin-bottom:6px;transition:padding .2s,margin .2s}.dashboard-row.cdk-drop-list-dragging,.dashboard-row.cdk-drop-list-receiving{border:1px dashed var(--color-component-border-200);padding:6px}.dashboard-row.cdk-drop-list-dragging .dashboard-item:not(.cdk-drag-placeholder){transition:transform .25s cubic-bezier(0,0,.2,1)}\n"]
            },] }
];
DashboardComponent.ctorParameters = () => [
    { type: DashboardWidgetService },
    { type: LocalStorageService },
    { type: ChangeDetectorRef },
    { type: DataService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvZGFzaGJvYXJkL3NyYy9jb21wb25lbnRzL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDOUYsT0FBTyxFQUVILHNCQUFzQixFQUV0QixXQUFXLEVBQ1gsbUJBQW1CLEdBR3RCLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRS9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFRMUMsTUFBTSxPQUFPLGtCQUFrQjtJQUszQixZQUNZLHNCQUE4QyxFQUM5QyxtQkFBd0MsRUFDeEMsa0JBQXFDLEVBQ3JDLFdBQXdCO1FBSHhCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO1FBQ3JDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBTm5CLG1CQUFjLEdBQUcsWUFBWSxDQUFDO0lBTzVDLENBQUM7SUFFSixRQUFRO1FBQ0osSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ3hFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFDL0MsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxF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QUFHLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQztpQkFDNUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDckQsTUFBTSxZQUFZLEdBQTJCLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNoRSxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ1gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2FBQ3BCLENBQUMsQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzlFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDcEUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1NBQzVEO0lBQ0wsQ0FBQzs7O1lBOUhKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZUFBZTtnQkFDekIsOHJHQUF5QztnQkFFekMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07O2FBQ2xEOzs7WUFoQkcsc0JBQXNCO1lBR3RCLG1CQUFtQjtZQU5XLGlCQUFpQjtZQUsvQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrRHJhZ0Ryb3AgfSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcclxuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge1xyXG4gICAgRGFzaGJvYXJkV2lkZ2V0Q29uZmlnLFxyXG4gICAgRGFzaGJvYXJkV2lkZ2V0U2VydmljZSxcclxuICAgIERhc2hib2FyZFdpZGdldFdpZHRoLFxyXG4gICAgRGF0YVNlcnZpY2UsXHJcbiAgICBMb2NhbFN0b3JhZ2VTZXJ2aWNlLFxyXG4gICAgV2lkZ2V0TGF5b3V0LFxyXG4gICAgV2lkZ2V0TGF5b3V0RGVmaW5pdGlvbixcclxufSBmcm9tICdAdmVuZHVyZS9hZG1pbi11aS9jb3JlJztcclxuaW1wb3J0IHsgYXNzZXJ0TmV2ZXIgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL3NoYXJlZC11dGlscyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAndmRyLWRhc2hib2FyZCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vZGFzaGJvYXJkLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuL2Rhc2hib2FyZC5jb21wb25lbnQuc2NzcyddLFxyXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gICAgd2lkZ2V0TGF5b3V0OiBXaWRnZXRMYXlvdXQgfCB1bmRlZmluZWQ7XHJcbiAgICBhdmFpbGFibGVXaWRnZXRJZHMkOiBPYnNlcnZhYmxlPHN0cmluZ1tdPjtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVsZXRpb25NYXJrZXIgPSAnX19kZWxldGVfXyc7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBkYXNoYm9hcmRXaWRnZXRTZXJ2aWNlOiBEYXNoYm9hcmRXaWRnZXRTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGNoYW5nZWREZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSBkYXRhU2VydmljZTogRGF0YVNlcnZpY2UsXHJcbiAgICApIHt9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5hdmFpbGFibGVXaWRnZXRJZHMkID0gdGhpcy5kYXRhU2VydmljZS5jbGllbnQudXNlclN0YXR1cygpLnN0cmVhbSQucGlwZShcclxuICAgICAgICAgICAgbWFwKCh7IHVzZXJTdGF0dXMgfSkgPT4gdXNlclN0YXR1cy5wZXJtaXNzaW9ucyksXHJcbiAgICAgICAgICAgIG1hcChwZXJtaXNzaW9ucyA9PiB0aGlzLmRhc2hib2FyZFdpZGdldFNlcnZpY2UuZ2V0QXZhaWxhYmxlSWRzKHBlcm1pc3Npb25zKSksXHJcbiAgICAgICAgICAgIHRhcChpZHMgPT4gKHRoaXMud2lkZ2V0TGF5b3V0ID0gdGhpcy5pbml0TGF5b3V0KGlkcykpKSxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENsYXNzRm9yV2lkdGgod2lkdGg6IERhc2hib2FyZFdpZGdldFdpZHRoKTogc3RyaW5nIHtcclxuICAgICAgICBzd2l0Y2ggKHdpZHRoKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgIHJldHVybiBgY2xyLWNvbC0xMiBjbHItY29sLXNtLTYgY2xyLWNvbC1sZy0zYDtcclxuICAgICAgICAgICAgY2FzZSA0OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGBjbHItY29sLTEyIGNsci1jb2wtc20tNiBjbHItY29sLWxnLTRgO1xyXG4gICAgICAgICAgICBjYXNlIDY6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYGNsci1jb2wtMTIgY2xyLWNvbC1sZy02YDtcclxuICAgICAgICAgICAgY2FzZSA4OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGBjbHItY29sLTEyIGNsci1jb2wtbGctOGA7XHJcbiAgICAgICAgICAgIGNhc2UgMTI6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYGNsci1jb2wtMTJgO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgYXNzZXJ0TmV2ZXIod2lkdGgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTdXBwb3J0ZWRXaWR0aHMoY29uZmlnOiBEYXNoYm9hcmRXaWRnZXRDb25maWcpOiBEYXNoYm9hcmRXaWRnZXRXaWR0aFtdIHtcclxuICAgICAgICByZXR1cm4gY29uZmlnLnN1cHBvcnRlZFdpZHRocyB8fCBbMywgNCwgNiwgOCwgMTJdO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFdpZGdldFdpZHRoKHdpZGdldDogV2lkZ2V0TGF5b3V0W251bWJlcl1bbnVtYmVyXSwgd2lkdGg6IERhc2hib2FyZFdpZGdldFdpZHRoKSB7XHJcbiAgICAgICAgd2lkZ2V0LndpZHRoID0gd2lkdGg7XHJcbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUxheW91dCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyYWNrUm93KGluZGV4OiBudW1iZXIsIHJvdzogV2lkZ2V0TGF5b3V0W251bWJlcl0pIHtcclxuICAgICAgICBjb25zdCBpZCA9IHJvdy5tYXAoaXRlbSA9PiBgJHtpdGVtLmlkfToke2l0ZW0ud2lkdGh9YCkuam9pbignfCcpO1xyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgIH1cclxuXHJcbiAgICB0cmFja1Jvd0l0ZW0oaW5kZXg6IG51bWJlciwgaXRlbTogV2lkZ2V0TGF5b3V0W251bWJlcl1bbnVtYmVyXSkge1xyXG4gICAgICAgIHJldHVybiBpdGVtLmNvbmZpZztcclxuICAgIH1cclxuXHJcbiAgICBhZGRXaWRnZXQoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuZGFzaGJvYXJkV2lkZ2V0U2VydmljZS5nZXRXaWRnZXRCeUlkKGlkKTtcclxuICAgICAgICBpZiAoY29uZmlnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gdGhpcy5nZXRTdXBwb3J0ZWRXaWR0aHMoY29uZmlnKVswXTtcclxuICAgICAgICAgICAgY29uc3Qgd2lkZ2V0OiBXaWRnZXRMYXlvdXRbbnVtYmVyXVtudW1iZXJdID0ge1xyXG4gICAgICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgICAgICBjb25maWcsXHJcbiAgICAgICAgICAgICAgICB3aWR0aCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgbGV0IHRhcmdldFJvdzogV2lkZ2V0TGF5b3V0W251bWJlcl07XHJcbiAgICAgICAgICAgIGlmICh0aGlzLndpZGdldExheW91dCAmJiB0aGlzLndpZGdldExheW91dC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRhcmdldFJvdyA9IHRoaXMud2lkZ2V0TGF5b3V0W3RoaXMud2lkZ2V0TGF5b3V0Lmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0Um93ID0gW107XHJcbiAgICAgICAgICAgICAgICB0aGlzLndpZGdldExheW91dD8ucHVzaCh0YXJnZXRSb3cpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRhcmdldFJvdy5wdXNoKHdpZGdldCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVjYWxjdWxhdGVMYXlvdXQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlV2lkZ2V0KHdpZGdldDogV2lkZ2V0TGF5b3V0W251bWJlcl1bbnVtYmVyXSkge1xyXG4gICAgICAgIHdpZGdldC5pZCA9IHRoaXMuZGVsZXRpb25NYXJrZXI7XHJcbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUxheW91dCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGRyb3AoZXZlbnQ6IENka0RyYWdEcm9wPHsgaW5kZXg6IG51bWJlciB9Pikge1xyXG4gICAgICAgIGNvbnN0IHsgY3VycmVudEluZGV4LCBwcmV2aW91c0luZGV4LCBwcmV2aW91c0NvbnRhaW5lciwgY29udGFpbmVyIH0gPSBldmVudDtcclxuICAgICAgICBpZiAocHJldmlvdXNJbmRleCA9PT0gY3VycmVudEluZGV4ICYmIHByZXZpb3VzQ29udGFpbmVyLmRhdGEuaW5kZXggPT09IGNvbnRhaW5lci5kYXRhLmluZGV4KSB7XHJcbiAgICAgICAgICAgIC8vIE5vdGhpbmcgY2hhbmdlZFxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLndpZGdldExheW91dCkge1xyXG4gICAgICAgICAgICBjb25zdCBwcmV2aW91c0xheW91dFJvdyA9IHRoaXMud2lkZ2V0TGF5b3V0W3ByZXZpb3VzQ29udGFpbmVyLmRhdGEuaW5kZXhdO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdMYXlvdXRSb3cgPSB0aGlzLndpZGdldExheW91dFtjb250YWluZXIuZGF0YS5pbmRleF07XHJcblxyXG4gICAgICAgICAgICBwcmV2aW91c0xheW91dFJvdy5zcGxpY2UocHJldmlvdXNJbmRleCwgMSk7XHJcbiAgICAgICAgICAgIG5ld0xheW91dFJvdy5zcGxpY2UoY3VycmVudEluZGV4LCAwLCBldmVudC5pdGVtLmRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlTGF5b3V0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdExheW91dChhdmFpbGFibGVJZHM6IHN0cmluZ1tdKTogV2lkZ2V0TGF5b3V0IHtcclxuICAgICAgICBjb25zdCBzYXZlZExheW91dERlZiA9IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2Rhc2hib2FyZFdpZGdldExheW91dCcpO1xyXG4gICAgICAgIGxldCBsYXlvdXREZWY6IFdpZGdldExheW91dERlZmluaXRpb24gfCB1bmRlZmluZWQ7XHJcbiAgICAgICAgaWYgKHNhdmVkTGF5b3V0RGVmKSB7XHJcbiAgICAgICAgICAgIC8vIHZhbGlkYXRlIGFsbCB0aGUgSURzIGZyb20gdGhlIHNhdmVkIGxheW91dCBhcmUgc3RpbGwgYXZhaWxhYmxlXHJcbiAgICAgICAgICAgIGxheW91dERlZiA9IHNhdmVkTGF5b3V0RGVmLmZpbHRlcihpdGVtID0+IGF2YWlsYWJsZUlkcy5pbmNsdWRlcyhpdGVtLmlkKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmRhc2hib2FyZFdpZGdldFNlcnZpY2UuZ2V0V2lkZ2V0TGF5b3V0KGxheW91dERlZik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWNhbGN1bGF0ZUxheW91dCgpIHtcclxuICAgICAgICBpZiAodGhpcy53aWRnZXRMYXlvdXQpIHtcclxuICAgICAgICAgICAgY29uc3QgZmxhdHRlbmVkID0gdGhpcy53aWRnZXRMYXlvdXRcclxuICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGZsYXQsIHJvdykgPT4gWy4uLmZsYXQsIC4uLnJvd10sIFtdKVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0uaWQgIT09IHRoaXMuZGVsZXRpb25NYXJrZXIpO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdMYXlvdXREZWY6IFdpZGdldExheW91dERlZmluaXRpb24gPSBmbGF0dGVuZWQubWFwKGl0ZW0gPT4gKHtcclxuICAgICAgICAgICAgICAgIGlkOiBpdGVtLmlkLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IGl0ZW0ud2lkdGgsXHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgdGhpcy53aWRnZXRMYXlvdXQgPSB0aGlzLmRhc2hib2FyZFdpZGdldFNlcnZpY2UuZ2V0V2lkZ2V0TGF5b3V0KG5ld0xheW91dERlZik7XHJcbiAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXQoJ2Rhc2hib2FyZFdpZGdldExheW91dCcsIG5ld0xheW91dERlZik7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5jaGFuZ2VkRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=