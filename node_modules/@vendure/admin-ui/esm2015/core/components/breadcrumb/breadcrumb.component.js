import { Component } from '@angular/core';
import { ActivatedRoute, NavigationEnd, PRIMARY_OUTLET, Router } from '@angular/router';
import { flatten } from 'lodash';
import { combineLatest as observableCombineLatest, Observable, of as observableOf, Subject } from 'rxjs';
import { filter, map, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { DataService } from '../../data/providers/data.service';
/**
 * A breadcrumbs component which reads the route config and any route that has a `data.breadcrumb` property will
 * be displayed in the breadcrumb trail.
 *
 * The `breadcrumb` property can be a string or a function. If a function, it will be passed the route's `data`
 * object (which will include all resolved keys) and any route params, and should return a BreadcrumbValue.
 *
 * See the test config to get an idea of allowable configs for breadcrumbs.
 */
export class BreadcrumbComponent {
    constructor(router, route, dataService) {
        this.router = router;
        this.route = route;
        this.dataService = dataService;
        this.destroy$ = new Subject();
        this.breadcrumbs$ = this.router.events.pipe(filter(event => event instanceof NavigationEnd), takeUntil(this.destroy$), startWith(true), switchMap(() => this.generateBreadcrumbs(this.route.root)));
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    generateBreadcrumbs(rootRoute) {
        const breadcrumbParts = this.assembleBreadcrumbParts(rootRoute);
        const breadcrumbObservables$ = breadcrumbParts.map(({ value$, path }) => {
            return value$.pipe(map(value => {
                if (isBreadcrumbLabelLinkPair(value)) {
                    return {
                        label: value.label,
                        link: this.normalizeRelativeLinks(value.link, path),
                    };
                }
                else if (isBreadcrumbPairArray(value)) {
                    return value.map(val => ({
                        label: val.label,
                        link: this.normalizeRelativeLinks(val.link, path),
                    }));
                }
                else {
                    return {
                        label: value,
                        link: '/' + path.join('/'),
                    };
                }
            }));
        });
        return observableCombineLatest(breadcrumbObservables$).pipe(map(links => flatten(links)));
    }
    /**
     * Walks the route definition tree to assemble an array from which the breadcrumbs can be derived.
     */
    assembleBreadcrumbParts(rootRoute) {
        const breadcrumbParts = [];
        const inferredUrl = '';
        const segmentPaths = [];
        let currentRoute = rootRoute;
        do {
            const childRoutes = currentRoute.children;
            currentRoute = null;
            childRoutes.forEach((route) => {
                if (route.outlet === PRIMARY_OUTLET) {
                    const routeSnapshot = route.snapshot;
                    let breadcrumbDef = route.routeConfig && route.routeConfig.data && route.routeConfig.data['breadcrumb'];
                    segmentPaths.push(routeSnapshot.url.map(segment => segment.path).join('/'));
                    if (breadcrumbDef) {
                        if (isBreadcrumbFunction(breadcrumbDef)) {
                            breadcrumbDef = breadcrumbDef(routeSnapshot.data, routeSnapshot.params, this.dataService);
                        }
                        const observableValue = isObservable(breadcrumbDef)
                            ? breadcrumbDef
                            : observableOf(breadcrumbDef);
                        breadcrumbParts.push({ value$: observableValue, path: segmentPaths.slice() });
                    }
                    currentRoute = route;
                }
            });
        } while (currentRoute);
        return breadcrumbParts;
    }
    /**
     * Accounts for relative routes in the link array, i.e. arrays whose first element is either:
     * * `./`   - this appends the rest of the link segments to the current active route
     * * `../`  - this removes the last segment of the current active route, and appends the link segments
     *            to the parent route.
     */
    normalizeRelativeLinks(link, segmentPaths) {
        const clone = link.slice();
        if (clone[0] === './') {
            clone[0] = segmentPaths.join('/');
        }
        if (clone[0] === '../') {
            clone[0] = segmentPaths.slice(0, -1).join('/');
        }
        return clone.filter(segment => segment !== '');
    }
}
BreadcrumbComponent.decorators = [
    { type: Component, args: [{
                selector: 'vdr-breadcrumb',
                template: "<nav role=\"navigation\">\r\n    <ul class=\"breadcrumbs\">\r\n        <li *ngFor=\"let breadcrumb of (breadcrumbs$ | async); let isLast = last\">\r\n            <a [routerLink]=\"breadcrumb.link\" *ngIf=\"!isLast\">{{ breadcrumb.label | translate }}</a>\r\n            <ng-container *ngIf=\"isLast\">{{ breadcrumb.label | translate }}</ng-container>\r\n        </li>\r\n    </ul>\r\n</nav>\r\n",
                styles: ["@charset \"UTF-8\";:host{display:block;padding:0 1rem}.breadcrumbs{list-style-type:none}.breadcrumbs li{font-size:16px;display:inline-block;margin-right:10px}.breadcrumbs li:not(:last-child):after{content:\"\\203a\";top:0;color:var(--color-grey-400);margin-left:10px}\n"]
            },] }
];
BreadcrumbComponent.ctorParameters = () => [
    { type: Router },
    { type: ActivatedRoute },
    { type: DataService }
];
function isBreadcrumbFunction(value) {
    return typeof value === 'function';
}
function isObservable(value) {
    return value instanceof Observable;
}
function isBreadcrumbLabelLinkPair(value) {
    return value.hasOwnProperty('label') && value.hasOwnProperty('link');
}
function isBreadcrumbPairArray(value) {
    return Array.isArray(value) && isBreadcrumbLabelLinkPair(value[0]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJlYWRjcnVtYi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2NvbXBvbmVudHMvYnJlYWRjcnVtYi9icmVhZGNydW1iLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxjQUFjLEVBQVEsYUFBYSxFQUFVLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxhQUFhLElBQUksdUJBQXVCLEVBQUUsVUFBVSxFQUFFLEVBQUUsSUFBSSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pHLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBZWhFOzs7Ozs7OztHQVFHO0FBTUgsTUFBTSxPQUFPLG1CQUFtQjtJQUk1QixZQUFvQixNQUFjLEVBQVUsS0FBcUIsRUFBVSxXQUF3QjtRQUEvRSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUYzRixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUduQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxFQUMvQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUN4QixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQ2YsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQzdELENBQUM7SUFDTixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRU8sbUJBQW1CLENBQ3ZCLFNBQXlCO1FBRXpCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNoRSxNQUFNLHNCQUFzQixHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQ3BFLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FDZCxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ1IsSUFBSSx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsRUFBRTtvQkFDbEMsT0FBTzt3QkFDSCxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7d0JBQ2xCLElBQUksRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7cUJBQ3RELENBQUM7aUJBQ0w7cUJBQU0sSUFBSSxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsRUFBRTtvQkFDckMsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDckIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLO3dCQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO3FCQUNwRCxDQUFDLENBQUMsQ0FBQztpQkFDUDtxQkFBTTtvQkFDSCxPQUFPO3dCQUNILEtBQUssRUFBRSxLQUFLO3dCQUNaLElBQUksRUFBRSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7cUJBQzdCLENBQUM7aUJBQ0w7WUFDTCxDQUFDLENBQUMsQ0FDOEQsQ0FBQztRQUN6RSxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sdUJBQXVCLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRUQ7O09BRUc7SUFDSyx1QkFBdUIsQ0FDM0IsU0FBeUI7UUFFekIsTUFBTSxlQUFlLEdBQW1FLEVBQUUsQ0FBQztRQUMzRixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdkIsTUFBTSxZQUFZLEdBQWEsRUFBRSxDQUFDO1FBQ2xDLElBQUksWUFBWSxHQUEwQixTQUFTLENBQUM7UUFDcEQsR0FBRztZQUNDLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7WUFDMUMsWUFBWSxHQUFHLElBQUksQ0FBQztZQUNwQixXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBcUIsRUFBRSxFQUFFO2dCQUMxQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssY0FBYyxFQUFFO29CQUNqQyxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO29CQUNyQyxJQUFJLGFBQWEsR0FDYixLQUFLLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUN4RixZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUU1RSxJQUFJLGFBQWEsRUFBRTt3QkFDZixJQUFJLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxFQUFFOzRCQUNyQyxhQUFhLEdBQUcsYUFBYSxDQUN6QixhQUFhLENBQUMsSUFBSSxFQUNsQixhQUFhLENBQUMsTUFBTSxFQUNwQixJQUFJLENBQUMsV0FBVyxDQUNuQixDQUFDO3lCQUNMO3dCQUNELE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUM7NEJBQy9DLENBQUMsQ0FBQyxhQUFhOzRCQUNmLENBQUMsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7d0JBQ2xDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO3FCQUNqRjtvQkFDRCxZQUFZLEdBQUcsS0FBSyxDQUFDO2lCQUN4QjtZQUNMLENBQUMsQ0FBQyxDQUFDO1NBQ04sUUFBUSxZQUFZLEVBQUU7UUFFdkIsT0FBTyxlQUFlLENBQUM7SUFDM0IsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssc0JBQXNCLENBQUMsSUFBVyxFQUFFLFlBQXNCO1FBQzlELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMzQixJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDbkIsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDckM7UUFDRCxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLEVBQUU7WUFDcEIsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7OztZQTdHSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGdCQUFnQjtnQkFDMUIsc1pBQTBDOzthQUU3Qzs7O1lBakNxRSxNQUFNO1lBQW5FLGNBQWM7WUFLZCxXQUFXOztBQXdJcEIsU0FBUyxvQkFBb0IsQ0FBQyxLQUEyQjtJQUNyRCxPQUFPLE9BQU8sS0FBSyxLQUFLLFVBQVUsQ0FBQztBQUN2QyxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsS0FBMkI7SUFDN0MsT0FBTyxLQUFLLFlBQVksVUFBVSxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLHlCQUF5QixDQUFDLEtBQXNCO0lBQ3JELE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pFLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLEtBQXNCO0lBQ2pELE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIERhdGEsIE5hdmlnYXRpb25FbmQsIFBhcmFtcywgUFJJTUFSWV9PVVRMRVQsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0IGFzIG9ic2VydmFibGVDb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiBhcyBvYnNlcnZhYmxlT2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uLy4uL2RhdGEvcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XHJcblxyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iU3RyaW5nID0gc3RyaW5nO1xyXG5leHBvcnQgaW50ZXJmYWNlIEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyIHtcclxuICAgIGxhYmVsOiBzdHJpbmc7XHJcbiAgICBsaW5rOiBhbnlbXTtcclxufVxyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iVmFsdWUgPSBCcmVhZGNydW1iU3RyaW5nIHwgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIgfCBCcmVhZGNydW1iTGFiZWxMaW5rUGFpcltdO1xyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iRnVuY3Rpb24gPSAoXHJcbiAgICBkYXRhOiBEYXRhLFxyXG4gICAgcGFyYW1zOiBQYXJhbXMsXHJcbiAgICBkYXRhU2VydmljZTogRGF0YVNlcnZpY2UsXHJcbikgPT4gQnJlYWRjcnVtYlZhbHVlIHwgT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+O1xyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iRGVmaW5pdGlvbiA9IEJyZWFkY3J1bWJWYWx1ZSB8IEJyZWFkY3J1bWJGdW5jdGlvbiB8IE9ic2VydmFibGU8QnJlYWRjcnVtYlZhbHVlPjtcclxuXHJcbi8qKlxyXG4gKiBBIGJyZWFkY3J1bWJzIGNvbXBvbmVudCB3aGljaCByZWFkcyB0aGUgcm91dGUgY29uZmlnIGFuZCBhbnkgcm91dGUgdGhhdCBoYXMgYSBgZGF0YS5icmVhZGNydW1iYCBwcm9wZXJ0eSB3aWxsXHJcbiAqIGJlIGRpc3BsYXllZCBpbiB0aGUgYnJlYWRjcnVtYiB0cmFpbC5cclxuICpcclxuICogVGhlIGBicmVhZGNydW1iYCBwcm9wZXJ0eSBjYW4gYmUgYSBzdHJpbmcgb3IgYSBmdW5jdGlvbi4gSWYgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBwYXNzZWQgdGhlIHJvdXRlJ3MgYGRhdGFgXHJcbiAqIG9iamVjdCAod2hpY2ggd2lsbCBpbmNsdWRlIGFsbCByZXNvbHZlZCBrZXlzKSBhbmQgYW55IHJvdXRlIHBhcmFtcywgYW5kIHNob3VsZCByZXR1cm4gYSBCcmVhZGNydW1iVmFsdWUuXHJcbiAqXHJcbiAqIFNlZSB0aGUgdGVzdCBjb25maWcgdG8gZ2V0IGFuIGlkZWEgb2YgYWxsb3dhYmxlIGNvbmZpZ3MgZm9yIGJyZWFkY3J1bWJzLlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3Zkci1icmVhZGNydW1iJyxcclxuICAgIHRlbXBsYXRlVXJsOiAnLi9icmVhZGNydW1iLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuL2JyZWFkY3J1bWIuY29tcG9uZW50LnNjc3MnXSxcclxufSlcclxuZXhwb3J0IGNsYXNzIEJyZWFkY3J1bWJDb21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gICAgYnJlYWRjcnVtYnMkOiBPYnNlcnZhYmxlPEFycmF5PHsgbGluazogc3RyaW5nIHwgYW55W107IGxhYmVsOiBzdHJpbmcgfT4+O1xyXG4gICAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlciwgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsIHByaXZhdGUgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5icmVhZGNydW1icyQgPSB0aGlzLnJvdXRlci5ldmVudHMucGlwZShcclxuICAgICAgICAgICAgZmlsdGVyKGV2ZW50ID0+IGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCksXHJcbiAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSxcclxuICAgICAgICAgICAgc3RhcnRXaXRoKHRydWUpLFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZW5lcmF0ZUJyZWFkY3J1bWJzKHRoaXMucm91dGUucm9vdCkpLFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2VuZXJhdGVCcmVhZGNydW1icyhcclxuICAgICAgICByb290Um91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgKTogT2JzZXJ2YWJsZTxBcnJheTx7IGxpbms6IEFycmF5PHN0cmluZyB8IGFueT47IGxhYmVsOiBzdHJpbmcgfT4+IHtcclxuICAgICAgICBjb25zdCBicmVhZGNydW1iUGFydHMgPSB0aGlzLmFzc2VtYmxlQnJlYWRjcnVtYlBhcnRzKHJvb3RSb3V0ZSk7XHJcbiAgICAgICAgY29uc3QgYnJlYWRjcnVtYk9ic2VydmFibGVzJCA9IGJyZWFkY3J1bWJQYXJ0cy5tYXAoKHsgdmFsdWUkLCBwYXRoIH0pID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlJC5waXBlKFxyXG4gICAgICAgICAgICAgICAgbWFwKHZhbHVlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNCcmVhZGNydW1iTGFiZWxMaW5rUGFpcih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB2YWx1ZS5sYWJlbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6IHRoaXMubm9ybWFsaXplUmVsYXRpdmVMaW5rcyh2YWx1ZS5saW5rLCBwYXRoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQnJlYWRjcnVtYlBhaXJBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh2YWwgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB2YWwubGFiZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiB0aGlzLm5vcm1hbGl6ZVJlbGF0aXZlTGlua3ModmFsLmxpbmssIHBhdGgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB2YWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6ICcvJyArIHBhdGguam9pbignLycpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICApIGFzIE9ic2VydmFibGU8QnJlYWRjcnVtYkxhYmVsTGlua1BhaXIgfCBCcmVhZGNydW1iTGFiZWxMaW5rUGFpcltdPjtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGVDb21iaW5lTGF0ZXN0KGJyZWFkY3J1bWJPYnNlcnZhYmxlcyQpLnBpcGUobWFwKGxpbmtzID0+IGZsYXR0ZW4obGlua3MpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBXYWxrcyB0aGUgcm91dGUgZGVmaW5pdGlvbiB0cmVlIHRvIGFzc2VtYmxlIGFuIGFycmF5IGZyb20gd2hpY2ggdGhlIGJyZWFkY3J1bWJzIGNhbiBiZSBkZXJpdmVkLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzc2VtYmxlQnJlYWRjcnVtYlBhcnRzKFxyXG4gICAgICAgIHJvb3RSb3V0ZTogQWN0aXZhdGVkUm91dGUsXHJcbiAgICApOiBBcnJheTx7IHZhbHVlJDogT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+OyBwYXRoOiBzdHJpbmdbXSB9PiB7XHJcbiAgICAgICAgY29uc3QgYnJlYWRjcnVtYlBhcnRzOiBBcnJheTx7IHZhbHVlJDogT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+OyBwYXRoOiBzdHJpbmdbXSB9PiA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGluZmVycmVkVXJsID0gJyc7XHJcbiAgICAgICAgY29uc3Qgc2VnbWVudFBhdGhzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIGxldCBjdXJyZW50Um91dGU6IEFjdGl2YXRlZFJvdXRlIHwgbnVsbCA9IHJvb3RSb3V0ZTtcclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkUm91dGVzID0gY3VycmVudFJvdXRlLmNoaWxkcmVuO1xyXG4gICAgICAgICAgICBjdXJyZW50Um91dGUgPSBudWxsO1xyXG4gICAgICAgICAgICBjaGlsZFJvdXRlcy5mb3JFYWNoKChyb3V0ZTogQWN0aXZhdGVkUm91dGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChyb3V0ZS5vdXRsZXQgPT09IFBSSU1BUllfT1VUTEVUKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVTbmFwc2hvdCA9IHJvdXRlLnNuYXBzaG90O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBicmVhZGNydW1iRGVmOiBCcmVhZGNydW1iRGVmaW5pdGlvbiB8IHVuZGVmaW5lZCA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlLnJvdXRlQ29uZmlnICYmIHJvdXRlLnJvdXRlQ29uZmlnLmRhdGEgJiYgcm91dGUucm91dGVDb25maWcuZGF0YVsnYnJlYWRjcnVtYiddO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlZ21lbnRQYXRocy5wdXNoKHJvdXRlU25hcHNob3QudXJsLm1hcChzZWdtZW50ID0+IHNlZ21lbnQucGF0aCkuam9pbignLycpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJyZWFkY3J1bWJEZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQnJlYWRjcnVtYkZ1bmN0aW9uKGJyZWFkY3J1bWJEZWYpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhZGNydW1iRGVmID0gYnJlYWRjcnVtYkRlZihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0ZVNuYXBzaG90LmRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGVTbmFwc2hvdC5wYXJhbXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhU2VydmljZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZVZhbHVlID0gaXNPYnNlcnZhYmxlKGJyZWFkY3J1bWJEZWYpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGJyZWFkY3J1bWJEZWZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogb2JzZXJ2YWJsZU9mKGJyZWFkY3J1bWJEZWYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhZGNydW1iUGFydHMucHVzaCh7IHZhbHVlJDogb2JzZXJ2YWJsZVZhbHVlLCBwYXRoOiBzZWdtZW50UGF0aHMuc2xpY2UoKSB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJvdXRlID0gcm91dGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gd2hpbGUgKGN1cnJlbnRSb3V0ZSk7XHJcblxyXG4gICAgICAgIHJldHVybiBicmVhZGNydW1iUGFydHM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBY2NvdW50cyBmb3IgcmVsYXRpdmUgcm91dGVzIGluIHRoZSBsaW5rIGFycmF5LCBpLmUuIGFycmF5cyB3aG9zZSBmaXJzdCBlbGVtZW50IGlzIGVpdGhlcjpcclxuICAgICAqICogYC4vYCAgIC0gdGhpcyBhcHBlbmRzIHRoZSByZXN0IG9mIHRoZSBsaW5rIHNlZ21lbnRzIHRvIHRoZSBjdXJyZW50IGFjdGl2ZSByb3V0ZVxyXG4gICAgICogKiBgLi4vYCAgLSB0aGlzIHJlbW92ZXMgdGhlIGxhc3Qgc2VnbWVudCBvZiB0aGUgY3VycmVudCBhY3RpdmUgcm91dGUsIGFuZCBhcHBlbmRzIHRoZSBsaW5rIHNlZ21lbnRzXHJcbiAgICAgKiAgICAgICAgICAgIHRvIHRoZSBwYXJlbnQgcm91dGUuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgbm9ybWFsaXplUmVsYXRpdmVMaW5rcyhsaW5rOiBhbnlbXSwgc2VnbWVudFBhdGhzOiBzdHJpbmdbXSk6IGFueVtdIHtcclxuICAgICAgICBjb25zdCBjbG9uZSA9IGxpbmsuc2xpY2UoKTtcclxuICAgICAgICBpZiAoY2xvbmVbMF0gPT09ICcuLycpIHtcclxuICAgICAgICAgICAgY2xvbmVbMF0gPSBzZWdtZW50UGF0aHMuam9pbignLycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2xvbmVbMF0gPT09ICcuLi8nKSB7XHJcbiAgICAgICAgICAgIGNsb25lWzBdID0gc2VnbWVudFBhdGhzLnNsaWNlKDAsIC0xKS5qb2luKCcvJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjbG9uZS5maWx0ZXIoc2VnbWVudCA9PiBzZWdtZW50ICE9PSAnJyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzQnJlYWRjcnVtYkZ1bmN0aW9uKHZhbHVlOiBCcmVhZGNydW1iRGVmaW5pdGlvbik6IHZhbHVlIGlzIEJyZWFkY3J1bWJGdW5jdGlvbiB7XHJcbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc09ic2VydmFibGUodmFsdWU6IEJyZWFkY3J1bWJEZWZpbml0aW9uKTogdmFsdWUgaXMgT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+IHtcclxuICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIE9ic2VydmFibGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIodmFsdWU6IEJyZWFkY3J1bWJWYWx1ZSk6IHZhbHVlIGlzIEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyIHtcclxuICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnbGFiZWwnKSAmJiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnbGluaycpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0JyZWFkY3J1bWJQYWlyQXJyYXkodmFsdWU6IEJyZWFkY3J1bWJWYWx1ZSk6IHZhbHVlIGlzIEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyW10ge1xyXG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIodmFsdWVbMF0pO1xyXG59XHJcbiJdfQ==