import { APP_INITIALIZER, Injectable } from '@angular/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import { BehaviorSubject, combineLatest, of } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { Permission } from '../../common/generated-types';
import * as i0 from "@angular/core";
/**
 * @description
 * Add a section to the main nav menu. Providing the `before` argument will
 * move the section before any existing section with the specified id. If
 * omitted (or if the id is not found) the section will be appended to the
 * existing set of sections.
 * This should be used in the NgModule `providers` array of your ui extension module.
 *
 * @example
 * ```TypeScript
 * \@NgModule({
 *   imports: [SharedModule],
 *   providers: [
 *     addNavMenuSection({
 *       id: 'reports',
 *       label: 'Reports',
 *       items: [{
 *           // ...
 *       }],
 *     },
 *     'settings'),
 *   ],
 * })
 * export class MyUiExtensionModule {}
 * ```
 * @docsCategory nav-menu
 */
export function addNavMenuSection(config, before) {
    return {
        provide: APP_INITIALIZER,
        multi: true,
        useFactory: (navBuilderService) => () => {
            navBuilderService.addNavMenuSection(config, before);
        },
        deps: [NavBuilderService],
    };
}
/**
 * @description
 * Add a menu item to an existing section specified by `sectionId`. The id of the section
 * can be found by inspecting the DOM and finding the `data-section-id` attribute.
 * Providing the `before` argument will move the item before any existing item with the specified id.
 * If omitted (or if the name is not found) the item will be appended to the
 * end of the section.
 *
 * This should be used in the NgModule `providers` array of your ui extension module.
 *
 * @example
 * ```TypeScript
 * \@NgModule({
 *   imports: [SharedModule],
 *   providers: [
 *     addNavMenuItem({
 *       id: 'reviews',
 *       label: 'Product Reviews',
 *       routerLink: ['/extensions/reviews'],
 *       icon: 'star',
 *     },
 *     'marketing'),
 *   ],
 * })
 * export class MyUiExtensionModule {}
 * ``
 *
 * @docsCategory nav-menu
 */
export function addNavMenuItem(config, sectionId, before) {
    return {
        provide: APP_INITIALIZER,
        multi: true,
        useFactory: (navBuilderService) => () => {
            navBuilderService.addNavMenuItem(config, sectionId, before);
        },
        deps: [NavBuilderService],
    };
}
/**
 * @description
 * Adds a button to the ActionBar at the top right of each list or detail view. The locationId can
 * be determined by inspecting the DOM and finding the <vdr-action-bar> element and its
 * `data-location-id` attribute.
 *
 * This should be used in the NgModule `providers` array of your ui extension module.
 *
 * @example
 * ```TypeScript
 * \@NgModule({
 *   imports: [SharedModule],
 *   providers: [
 *     addActionBarItem({
 *      id: 'print-invoice'
 *      label: 'Print Invoice',
 *      locationId: 'order-detail',
 *      routerLink: ['/extensions/invoicing'],
 *     }),
 *   ],
 * })
 * export class MyUiExtensionModule {}
 * ```
 * @docsCategory action-bar
 */
export function addActionBarItem(config) {
    return {
        provide: APP_INITIALIZER,
        multi: true,
        useFactory: (navBuilderService) => () => {
            navBuilderService.addActionBarItem(config);
        },
        deps: [NavBuilderService],
    };
}
/**
 * This service is used to define the contents of configurable menus in the application.
 */
export class NavBuilderService {
    constructor() {
        this.sectionBadges = {};
        this.initialNavMenuConfig$ = new BehaviorSubject([]);
        this.addedNavMenuSections = [];
        this.addedNavMenuItems = [];
        this.addedActionBarItems = [];
        this.setupStreams();
    }
    /**
     * Used to define the initial sections and items of the main nav menu.
     */
    defineNavMenuSections(config) {
        this.initialNavMenuConfig$.next(config);
    }
    /**
     * Add a section to the main nav menu. Providing the `before` argument will
     * move the section before any existing section with the specified id. If
     * omitted (or if the id is not found) the section will be appended to the
     * existing set of sections.
     *
     * Providing the `id` of an existing section will replace that section.
     */
    addNavMenuSection(config, before) {
        this.addedNavMenuSections.push({ config, before });
    }
    /**
     * Add a menu item to an existing section specified by `sectionId`. The id of the section
     * can be found by inspecting the DOM and finding the `data-section-id` attribute.
     * Providing the `before` argument will move the item before any existing item with the specified id.
     * If omitted (or if the name is not found) the item will be appended to the
     * end of the section.
     *
     * Providing the `id` of an existing item in that section will replace
     * that item.
     */
    addNavMenuItem(config, sectionId, before) {
        this.addedNavMenuItems.push({ config, sectionId, before });
    }
    /**
     * Adds a button to the ActionBar at the top right of each list or detail view. The locationId can
     * be determined by inspecting the DOM and finding the <vdr-action-bar> element and its
     * `data-location-id` attribute.
     */
    addActionBarItem(config) {
        this.addedActionBarItems.push(Object.assign({ requiresPermission: Permission.Authenticated }, config));
    }
    getRouterLink(config, route) {
        if (typeof config.routerLink === 'function') {
            return config.routerLink(route);
        }
        if (Array.isArray(config.routerLink)) {
            return config.routerLink;
        }
        return null;
    }
    setupStreams() {
        const sectionAdditions$ = of(this.addedNavMenuSections);
        const itemAdditions$ = of(this.addedNavMenuItems);
        const combinedConfig$ = combineLatest(this.initialNavMenuConfig$, sectionAdditions$).pipe(map(([initialConfig, additions]) => {
            for (const { config, before } of additions) {
                if (!config.requiresPermission) {
                    config.requiresPermission = Permission.Authenticated;
                }
                const existingIndex = initialConfig.findIndex(c => c.id === config.id);
                if (-1 < existingIndex) {
                    initialConfig[existingIndex] = config;
                }
                const beforeIndex = initialConfig.findIndex(c => c.id === before);
                if (-1 < beforeIndex) {
                    if (-1 < existingIndex) {
                        initialConfig.splice(existingIndex, 1);
                    }
                    initialConfig.splice(beforeIndex, 0, config);
                }
                else if (existingIndex === -1) {
                    initialConfig.push(config);
                }
            }
            return initialConfig;
        }), shareReplay(1));
        this.navMenuConfig$ = combineLatest(combinedConfig$, itemAdditions$).pipe(map(([sections, additionalItems]) => {
            for (const item of additionalItems) {
                const section = sections.find(s => s.id === item.sectionId);
                if (!section) {
                    // tslint:disable-next-line:no-console
                    console.error(`Could not add menu item "${item.config.id}", section "${item.sectionId}" does not exist`);
                }
                else {
                    const { config, sectionId, before } = item;
                    const existingIndex = section.items.findIndex(i => i.id === config.id);
                    if (-1 < existingIndex) {
                        section.items[existingIndex] = config;
                    }
                    const beforeIndex = section.items.findIndex(i => i.id === before);
                    if (-1 < beforeIndex) {
                        if (-1 < existingIndex) {
                            section.items.splice(existingIndex, 1);
                        }
                        section.items.splice(beforeIndex, 0, config);
                    }
                    else if (existingIndex === -1) {
                        section.items.push(config);
                    }
                }
            }
            // Aggregate any badges defined for the nav items in each section
            for (const section of sections) {
                const itemBadgeStatuses = section.items
                    .map(i => i.statusBadge)
                    .filter(notNullOrUndefined);
                this.sectionBadges[section.id] = combineLatest(itemBadgeStatuses).pipe(map(badges => {
                    const propagatingBadges = badges.filter(b => b.propagateToSection);
                    if (propagatingBadges.length === 0) {
                        return 'none';
                    }
                    const statuses = propagatingBadges.map(b => b.type);
                    if (statuses.includes('error')) {
                        return 'error';
                    }
                    else if (statuses.includes('warning')) {
                        return 'warning';
                    }
                    else if (statuses.includes('info')) {
                        return 'info';
                    }
                    else {
                        return 'none';
                    }
                }));
            }
            return sections;
        }));
        this.actionBarConfig$ = of(this.addedActionBarItems);
    }
}
NavBuilderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NavBuilderService_Factory() { return new NavBuilderService(); }, token: NavBuilderService, providedIn: "root" });
NavBuilderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
NavBuilderService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvcHJvdmlkZXJzL25hdi1idWlsZGVyL25hdi1idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQVksTUFBTSxlQUFlLENBQUM7QUFFdEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDhCQUE4QixDQUFDOztBQVUxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0EwQkc7QUFDSCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsTUFBc0IsRUFBRSxNQUFlO0lBQ3JFLE9BQU87UUFDSCxPQUFPLEVBQUUsZUFBZTtRQUN4QixLQUFLLEVBQUUsSUFBSTtRQUNYLFVBQVUsRUFBRSxDQUFDLGlCQUFvQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUU7WUFDdkQsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3hELENBQUM7UUFDRCxJQUFJLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztLQUM1QixDQUFDO0FBQ04sQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBNEJHO0FBQ0gsTUFBTSxVQUFVLGNBQWMsQ0FBQyxNQUFtQixFQUFFLFNBQWlCLEVBQUUsTUFBZTtJQUNsRixPQUFPO1FBQ0gsT0FBTyxFQUFFLGVBQWU7UUFDeEIsS0FBSyxFQUFFLElBQUk7UUFDWCxVQUFVLEVBQUUsQ0FBQyxpQkFBb0Ms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QUNMLENBQUM7UUFFRixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3pELENBQUM7Ozs7WUFsS0osVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBQX0lOSVRJQUxJWkVSLCBJbmplY3RhYmxlLCBQcm92aWRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IG5vdE51bGxPclVuZGVmaW5lZCB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLXV0aWxzJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHNoYXJlUmVwbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2NvbW1vbi9nZW5lcmF0ZWQtdHlwZXMnO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIEFjdGlvbkJhckl0ZW0sXHJcbiAgICBOYXZNZW51QmFkZ2VUeXBlLFxyXG4gICAgTmF2TWVudUl0ZW0sXHJcbiAgICBOYXZNZW51U2VjdGlvbixcclxuICAgIFJvdXRlckxpbmtEZWZpbml0aW9uLFxyXG59IGZyb20gJy4vbmF2LWJ1aWxkZXItdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBBZGQgYSBzZWN0aW9uIHRvIHRoZSBtYWluIG5hdiBtZW51LiBQcm92aWRpbmcgdGhlIGBiZWZvcmVgIGFyZ3VtZW50IHdpbGxcclxuICogbW92ZSB0aGUgc2VjdGlvbiBiZWZvcmUgYW55IGV4aXN0aW5nIHNlY3Rpb24gd2l0aCB0aGUgc3BlY2lmaWVkIGlkLiBJZlxyXG4gKiBvbWl0dGVkIChvciBpZiB0aGUgaWQgaXMgbm90IGZvdW5kKSB0aGUgc2VjdGlvbiB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZVxyXG4gKiBleGlzdGluZyBzZXQgb2Ygc2VjdGlvbnMuXHJcbiAqIFRoaXMgc2hvdWxkIGJlIHVzZWQgaW4gdGhlIE5nTW9kdWxlIGBwcm92aWRlcnNgIGFycmF5IG9mIHlvdXIgdWkgZXh0ZW5zaW9uIG1vZHVsZS5cclxuICpcclxuICogQGV4YW1wbGVcclxuICogYGBgVHlwZVNjcmlwdFxyXG4gKiBcXEBOZ01vZHVsZSh7XHJcbiAqICAgaW1wb3J0czogW1NoYXJlZE1vZHVsZV0sXHJcbiAqICAgcHJvdmlkZXJzOiBbXHJcbiAqICAgICBhZGROYXZNZW51U2VjdGlvbih7XHJcbiAqICAgICAgIGlkOiAncmVwb3J0cycsXHJcbiAqICAgICAgIGxhYmVsOiAnUmVwb3J0cycsXHJcbiAqICAgICAgIGl0ZW1zOiBbe1xyXG4gKiAgICAgICAgICAgLy8gLi4uXHJcbiAqICAgICAgIH1dLFxyXG4gKiAgICAgfSxcclxuICogICAgICdzZXR0aW5ncycpLFxyXG4gKiAgIF0sXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBNeVVpRXh0ZW5zaW9uTW9kdWxlIHt9XHJcbiAqIGBgYFxyXG4gKiBAZG9jc0NhdGVnb3J5IG5hdi1tZW51XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gYWRkTmF2TWVudVNlY3Rpb24oY29uZmlnOiBOYXZNZW51U2VjdGlvbiwgYmVmb3JlPzogc3RyaW5nKTogUHJvdmlkZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwcm92aWRlOiBBUFBfSU5JVElBTElaRVIsXHJcbiAgICAgICAgbXVsdGk6IHRydWUsXHJcbiAgICAgICAgdXNlRmFjdG9yeTogKG5hdkJ1aWxkZXJTZXJ2aWNlOiBOYXZCdWlsZGVyU2VydmljZSkgPT4gKCkgPT4ge1xyXG4gICAgICAgICAgICBuYXZCdWlsZGVyU2VydmljZS5hZGROYXZNZW51U2VjdGlvbihjb25maWcsIGJlZm9yZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkZXBzOiBbTmF2QnVpbGRlclNlcnZpY2VdLFxyXG4gICAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBBZGQgYSBtZW51IGl0ZW0gdG8gYW4gZXhpc3Rpbmcgc2VjdGlvbiBzcGVjaWZpZWQgYnkgYHNlY3Rpb25JZGAuIFRoZSBpZCBvZiB0aGUgc2VjdGlvblxyXG4gKiBjYW4gYmUgZm91bmQgYnkgaW5zcGVjdGluZyB0aGUgRE9NIGFuZCBmaW5kaW5nIHRoZSBgZGF0YS1zZWN0aW9uLWlkYCBhdHRyaWJ1dGUuXHJcbiAqIFByb3ZpZGluZyB0aGUgYGJlZm9yZWAgYXJndW1lbnQgd2lsbCBtb3ZlIHRoZSBpdGVtIGJlZm9yZSBhbnkgZXhpc3RpbmcgaXRlbSB3aXRoIHRoZSBzcGVjaWZpZWQgaWQuXHJcbiAqIElmIG9taXR0ZWQgKG9yIGlmIHRoZSBuYW1lIGlzIG5vdCBmb3VuZCkgdGhlIGl0ZW0gd2lsbCBiZSBhcHBlbmRlZCB0byB0aGVcclxuICogZW5kIG9mIHRoZSBzZWN0aW9uLlxyXG4gKlxyXG4gKiBUaGlzIHNob3VsZCBiZSB1c2VkIGluIHRoZSBOZ01vZHVsZSBgcHJvdmlkZXJzYCBhcnJheSBvZiB5b3VyIHVpIGV4dGVuc2lvbiBtb2R1bGUuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYFR5cGVTY3JpcHRcclxuICogXFxATmdNb2R1bGUoe1xyXG4gKiAgIGltcG9ydHM6IFtTaGFyZWRNb2R1bGVdLFxyXG4gKiAgIHByb3ZpZGVyczogW1xyXG4gKiAgICAgYWRkTmF2TWVudUl0ZW0oe1xyXG4gKiAgICAgICBpZDogJ3Jldmlld3MnLFxyXG4gKiAgICAgICBsYWJlbDogJ1Byb2R1Y3QgUmV2aWV3cycsXHJcbiAqICAgICAgIHJvdXRlckxpbms6IFsnL2V4dGVuc2lvbnMvcmV2aWV3cyddLFxyXG4gKiAgICAgICBpY29uOiAnc3RhcicsXHJcbiAqICAgICB9LFxyXG4gKiAgICAgJ21hcmtldGluZycpLFxyXG4gKiAgIF0sXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBNeVVpRXh0ZW5zaW9uTW9kdWxlIHt9XHJcbiAqIGBgXHJcbiAqXHJcbiAqIEBkb2NzQ2F0ZWdvcnkgbmF2LW1lbnVcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGROYXZNZW51SXRlbShjb25maWc6IE5hdk1lbnVJdGVtLCBzZWN0aW9uSWQ6IHN0cmluZywgYmVmb3JlPzogc3RyaW5nKTogUHJvdmlkZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwcm92aWRlOiBBUFBfSU5JVElBTElaRVIsXHJcbiAgICAgICAgbXVsdGk6IHRydWUsXHJcbiAgICAgICAgdXNlRmFjdG9yeTogKG5hdkJ1aWxkZXJTZXJ2aWNlOiBOYXZCdWlsZGVyU2VydmljZSkgPT4gKCkgPT4ge1xyXG4gICAgICAgICAgICBuYXZCdWlsZGVyU2VydmljZS5hZGROYXZNZW51SXRlbShjb25maWcsIHNlY3Rpb25JZCwgYmVmb3JlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGRlcHM6IFtOYXZCdWlsZGVyU2VydmljZV0sXHJcbiAgICB9O1xyXG59XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIEFkZHMgYSBidXR0b24gdG8gdGhlIEFjdGlvbkJhciBhdCB0aGUgdG9wIHJpZ2h0IG9mIGVhY2ggbGlzdCBvciBkZXRhaWwgdmlldy4gVGhlIGxvY2F0aW9uSWQgY2FuXHJcbiAqIGJlIGRldGVybWluZWQgYnkgaW5zcGVjdGluZyB0aGUgRE9NIGFuZCBmaW5kaW5nIHRoZSA8dmRyLWFjdGlvbi1iYXI+IGVsZW1lbnQgYW5kIGl0c1xyXG4gKiBgZGF0YS1sb2NhdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gKlxyXG4gKiBUaGlzIHNob3VsZCBiZSB1c2VkIGluIHRoZSBOZ01vZHVsZSBgcHJvdmlkZXJzYCBhcnJheSBvZiB5b3VyIHVpIGV4dGVuc2lvbiBtb2R1bGUuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYFR5cGVTY3JpcHRcclxuICogXFxATmdNb2R1bGUoe1xyXG4gKiAgIGltcG9ydHM6IFtTaGFyZWRNb2R1bGVdLFxyXG4gKiAgIHByb3ZpZGVyczogW1xyXG4gKiAgICAgYWRkQWN0aW9uQmFySXRlbSh7XHJcbiAqICAgICAgaWQ6ICdwcmludC1pbnZvaWNlJ1xyXG4gKiAgICAgIGxhYmVsOiAnUHJpbnQgSW52b2ljZScsXHJcbiAqICAgICAgbG9jYXRpb25JZDogJ29yZGVyLWRldGFpbCcsXHJcbiAqICAgICAgcm91dGVyTGluazogWycvZXh0ZW5zaW9ucy9pbnZvaWNpbmcnXSxcclxuICogICAgIH0pLFxyXG4gKiAgIF0sXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBNeVVpRXh0ZW5zaW9uTW9kdWxlIHt9XHJcbiAqIGBgYFxyXG4gKiBAZG9jc0NhdGVnb3J5IGFjdGlvbi1iYXJcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRBY3Rpb25CYXJJdGVtKGNvbmZpZzogQWN0aW9uQmFySXRlbSk6IFByb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgcHJvdmlkZTogQVBQX0lOSVRJQUxJWkVSLFxyXG4gICAgICAgIG11bHRpOiB0cnVlLFxyXG4gICAgICAgIHVzZUZhY3Rvcnk6IChuYXZCdWlsZGVyU2VydmljZTogTmF2QnVpbGRlclNlcnZpY2UpID0+ICgpID0+IHtcclxuICAgICAgICAgICAgbmF2QnVpbGRlclNlcnZpY2UuYWRkQWN0aW9uQmFySXRlbShjb25maWcpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZGVwczogW05hdkJ1aWxkZXJTZXJ2aWNlXSxcclxuICAgIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGlzIHNlcnZpY2UgaXMgdXNlZCB0byBkZWZpbmUgdGhlIGNvbnRlbnRzIG9mIGNvbmZpZ3VyYWJsZSBtZW51cyBpbiB0aGUgYXBwbGljYXRpb24uXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOYXZCdWlsZGVyU2VydmljZSB7XHJcbiAgICBuYXZNZW51Q29uZmlnJDogT2JzZXJ2YWJsZTxOYXZNZW51U2VjdGlvbltdPjtcclxuICAgIGFjdGlvbkJhckNvbmZpZyQ6IE9ic2VydmFibGU8QWN0aW9uQmFySXRlbVtdPjtcclxuICAgIHNlY3Rpb25CYWRnZXM6IHsgW3NlY3Rpb25JZDogc3RyaW5nXTogT2JzZXJ2YWJsZTxOYXZNZW51QmFkZ2VUeXBlPiB9ID0ge307XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0aWFsTmF2TWVudUNvbmZpZyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5hdk1lbnVTZWN0aW9uW10+KFtdKTtcclxuICAgIHByaXZhdGUgYWRkZWROYXZNZW51U2VjdGlvbnM6IEFycmF5PHsgY29uZmlnOiBOYXZNZW51U2VjdGlvbjsgYmVmb3JlPzogc3RyaW5nIH0+ID0gW107XHJcbiAgICBwcml2YXRlIGFkZGVkTmF2TWVudUl0ZW1zOiBBcnJheTx7XHJcbiAgICAgICAgY29uZmlnOiBOYXZNZW51SXRlbTtcclxuICAgICAgICBzZWN0aW9uSWQ6IHN0cmluZztcclxuICAgICAgICBiZWZvcmU/OiBzdHJpbmc7XHJcbiAgICB9PiA9IFtdO1xyXG4gICAgcHJpdmF0ZSBhZGRlZEFjdGlvbkJhckl0ZW1zOiBBY3Rpb25CYXJJdGVtW10gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLnNldHVwU3RyZWFtcygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVXNlZCB0byBkZWZpbmUgdGhlIGluaXRpYWwgc2VjdGlvbnMgYW5kIGl0ZW1zIG9mIHRoZSBtYWluIG5hdiBtZW51LlxyXG4gICAgICovXHJcbiAgICBkZWZpbmVOYXZNZW51U2VjdGlvbnMoY29uZmlnOiBOYXZNZW51U2VjdGlvbltdKSB7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsTmF2TWVudUNvbmZpZyQubmV4dChjb25maWcpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkIGEgc2VjdGlvbiB0byB0aGUgbWFpbiBuYXYgbWVudS4gUHJvdmlkaW5nIHRoZSBgYmVmb3JlYCBhcmd1bWVudCB3aWxsXHJcbiAgICAgKiBtb3ZlIHRoZSBzZWN0aW9uIGJlZm9yZSBhbnkgZXhpc3Rpbmcgc2VjdGlvbiB3aXRoIHRoZSBzcGVjaWZpZWQgaWQuIElmXHJcbiAgICAgKiBvbWl0dGVkIChvciBpZiB0aGUgaWQgaXMgbm90IGZvdW5kKSB0aGUgc2VjdGlvbiB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZVxyXG4gICAgICogZXhpc3Rpbmcgc2V0IG9mIHNlY3Rpb25zLlxyXG4gICAgICpcclxuICAgICAqIFByb3ZpZGluZyB0aGUgYGlkYCBvZiBhbiBleGlzdGluZyBzZWN0aW9uIHdpbGwgcmVwbGFjZSB0aGF0IHNlY3Rpb24uXHJcbiAgICAgKi9cclxuICAgIGFkZE5hdk1lbnVTZWN0aW9uKGNvbmZpZzogTmF2TWVudVNlY3Rpb24sIGJlZm9yZT86IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuYWRkZWROYXZNZW51U2VjdGlvbnMucHVzaCh7IGNvbmZpZywgYmVmb3JlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkIGEgbWVudSBpdGVtIHRvIGFuIGV4aXN0aW5nIHNlY3Rpb24gc3BlY2lmaWVkIGJ5IGBzZWN0aW9uSWRgLiBUaGUgaWQgb2YgdGhlIHNlY3Rpb25cclxuICAgICAqIGNhbiBiZSBmb3VuZCBieSBpbnNwZWN0aW5nIHRoZSBET00gYW5kIGZpbmRpbmcgdGhlIGBkYXRhLXNlY3Rpb24taWRgIGF0dHJpYnV0ZS5cclxuICAgICAqIFByb3ZpZGluZyB0aGUgYGJlZm9yZWAgYXJndW1lbnQgd2lsbCBtb3ZlIHRoZSBpdGVtIGJlZm9yZSBhbnkgZXhpc3RpbmcgaXRlbSB3aXRoIHRoZSBzcGVjaWZpZWQgaWQuXHJcbiAgICAgKiBJZiBvbWl0dGVkIChvciBpZiB0aGUgbmFtZSBpcyBub3QgZm91bmQpIHRoZSBpdGVtIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlXHJcbiAgICAgKiBlbmQgb2YgdGhlIHNlY3Rpb24uXHJcbiAgICAgKlxyXG4gICAgICogUHJvdmlkaW5nIHRoZSBgaWRgIG9mIGFuIGV4aXN0aW5nIGl0ZW0gaW4gdGhhdCBzZWN0aW9uIHdpbGwgcmVwbGFjZVxyXG4gICAgICogdGhhdCBpdGVtLlxyXG4gICAgICovXHJcbiAgICBhZGROYXZNZW51SXRlbShjb25maWc6IE5hdk1lbnVJdGVtLCBzZWN0aW9uSWQ6IHN0cmluZywgYmVmb3JlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZE5hdk1lbnVJdGVtcy5wdXNoKHsgY29uZmlnLCBzZWN0aW9uSWQsIGJlZm9yZSB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFkZHMgYSBidXR0b24gdG8gdGhlIEFjdGlvbkJhciBhdCB0aGUgdG9wIHJpZ2h0IG9mIGVhY2ggbGlzdCBvciBkZXRhaWwgdmlldy4gVGhlIGxvY2F0aW9uSWQgY2FuXHJcbiAgICAgKiBiZSBkZXRlcm1pbmVkIGJ5IGluc3BlY3RpbmcgdGhlIERPTSBhbmQgZmluZGluZyB0aGUgPHZkci1hY3Rpb24tYmFyPiBlbGVtZW50IGFuZCBpdHNcclxuICAgICAqIGBkYXRhLWxvY2F0aW9uLWlkYCBhdHRyaWJ1dGUuXHJcbiAgICAgKi9cclxuICAgIGFkZEFjdGlvbkJhckl0ZW0oY29uZmlnOiBBY3Rpb25CYXJJdGVtKSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZEFjdGlvbkJhckl0ZW1zLnB1c2goe1xyXG4gICAgICAgICAgICByZXF1aXJlc1Blcm1pc3Npb246IFBlcm1pc3Npb24uQXV0aGVudGljYXRlZCxcclxuICAgICAgICAgICAgLi4uY29uZmlnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFJvdXRlckxpbmsoY29uZmlnOiB7IHJvdXRlckxpbms/OiBSb3V0ZXJMaW5rRGVmaW5pdGlvbiB9LCByb3V0ZTogQWN0aXZhdGVkUm91dGUpOiBzdHJpbmdbXSB8IG51bGwge1xyXG4gICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJvdXRlckxpbmsgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5yb3V0ZXJMaW5rKHJvdXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29uZmlnLnJvdXRlckxpbmspKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWcucm91dGVyTGluaztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXR1cFN0cmVhbXMoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VjdGlvbkFkZGl0aW9ucyQgPSBvZih0aGlzLmFkZGVkTmF2TWVudVNlY3Rpb25zKTtcclxuICAgICAgICBjb25zdCBpdGVtQWRkaXRpb25zJCA9IG9mKHRoaXMuYWRkZWROYXZNZW51SXRlbXMpO1xyXG5cclxuICAgICAgICBjb25zdCBjb21iaW5lZENvbmZpZyQgPSBjb21iaW5lTGF0ZXN0KHRoaXMuaW5pdGlhbE5hdk1lbnVDb25maWckLCBzZWN0aW9uQWRkaXRpb25zJCkucGlwZShcclxuICAgICAgICAgICAgbWFwKChbaW5pdGlhbENvbmZpZywgYWRkaXRpb25zXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB7IGNvbmZpZywgYmVmb3JlIH0gb2YgYWRkaXRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcucmVxdWlyZXNQZXJtaXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5yZXF1aXJlc1Blcm1pc3Npb24gPSBQZXJtaXNzaW9uLkF1dGhlbnRpY2F0ZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nSW5kZXggPSBpbml0aWFsQ29uZmlnLmZpbmRJbmRleChjID0+IGMuaWQgPT09IGNvbmZpZy5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKC0xIDwgZXhpc3RpbmdJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsQ29uZmlnW2V4aXN0aW5nSW5kZXhdID0gY29uZmlnO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBiZWZvcmVJbmRleCA9IGluaXRpYWxDb25maWcuZmluZEluZGV4KGMgPT4gYy5pZCA9PT0gYmVmb3JlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoLTEgPCBiZWZvcmVJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoLTEgPCBleGlzdGluZ0luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsQ29uZmlnLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsQ29uZmlnLnNwbGljZShiZWZvcmVJbmRleCwgMCwgY29uZmlnKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWcucHVzaChjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBpbml0aWFsQ29uZmlnO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgc2hhcmVSZXBsYXkoMSksXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5uYXZNZW51Q29uZmlnJCA9IGNvbWJpbmVMYXRlc3QoY29tYmluZWRDb25maWckLCBpdGVtQWRkaXRpb25zJCkucGlwZShcclxuICAgICAgICAgICAgbWFwKChbc2VjdGlvbnMsIGFkZGl0aW9uYWxJdGVtc10pID0+IHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBhZGRpdGlvbmFsSXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWN0aW9uID0gc2VjdGlvbnMuZmluZChzID0+IHMuaWQgPT09IGl0ZW0uc2VjdGlvbklkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXNlY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBDb3VsZCBub3QgYWRkIG1lbnUgaXRlbSBcIiR7aXRlbS5jb25maWcuaWR9XCIsIHNlY3Rpb24gXCIke2l0ZW0uc2VjdGlvbklkfVwiIGRvZXMgbm90IGV4aXN0YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGNvbmZpZywgc2VjdGlvbklkLCBiZWZvcmUgfSA9IGl0ZW07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nSW5kZXggPSBzZWN0aW9uLml0ZW1zLmZpbmRJbmRleChpID0+IGkuaWQgPT09IGNvbmZpZy5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGV4aXN0aW5nSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rpb24uaXRlbXNbZXhpc3RpbmdJbmRleF0gPSBjb25maWc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmVmb3JlSW5kZXggPSBzZWN0aW9uLml0ZW1zLmZpbmRJbmRleChpID0+IGkuaWQgPT09IGJlZm9yZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGJlZm9yZUluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLTEgPCBleGlzdGluZ0luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbi5pdGVtcy5zcGxpY2UoZXhpc3RpbmdJbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLml0ZW1zLnNwbGljZShiZWZvcmVJbmRleCwgMCwgY29uZmlnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleGlzdGluZ0luZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbi5pdGVtcy5wdXNoKGNvbmZpZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQWdncmVnYXRlIGFueSBiYWRnZXMgZGVmaW5lZCBmb3IgdGhlIG5hdiBpdGVtcyBpbiBlYWNoIHNlY3Rpb25cclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc2VjdGlvbiBvZiBzZWN0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1CYWRnZVN0YXR1c2VzID0gc2VjdGlvbi5pdGVtc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKGkgPT4gaS5zdGF0dXNCYWRnZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihub3ROdWxsT3JVbmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VjdGlvbkJhZGdlc1tzZWN0aW9uLmlkXSA9IGNvbWJpbmVMYXRlc3QoaXRlbUJhZGdlU3RhdHVzZXMpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcChiYWRnZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcGFnYXRpbmdCYWRnZXMgPSBiYWRnZXMuZmlsdGVyKGIgPT4gYi5wcm9wYWdhdGVUb1NlY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BhZ2F0aW5nQmFkZ2VzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNlcyA9IHByb3BhZ2F0aW5nQmFkZ2VzLm1hcChiID0+IGIudHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzZXMuaW5jbHVkZXMoJ2Vycm9yJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2Vycm9yJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzZXMuaW5jbHVkZXMoJ3dhcm5pbmcnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnd2FybmluZyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1c2VzLmluY2x1ZGVzKCdpbmZvJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2luZm8nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBzZWN0aW9ucztcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5hY3Rpb25CYXJDb25maWckID0gb2YodGhpcy5hZGRlZEFjdGlvbkJhckl0ZW1zKTtcclxuICAgIH1cclxufVxyXG4iXX0=