import { __awaiter } from "tslib";
import { ComponentFactoryResolver, Injectable } from '@angular/core';
import { NotificationComponent } from '../../components/notification/notification.component';
import { I18nService } from '../i18n/i18n.service';
import { OverlayHostService } from '../overlay-host/overlay-host.service';
import * as i0 from "@angular/core";
import * as i1 from "../i18n/i18n.service";
import * as i2 from "../overlay-host/overlay-host.service";
// How many ms before the toast is dismissed.
const TOAST_DURATION = 3000;
/**
 * @description
 * Provides toast notification functionality.
 *
 * @example
 * ```TypeScript
 * class MyComponent {
 *   constructor(private notificationService: NotificationService) {}
 *
 *   save() {
 *     this.notificationService
 *         .success(_('asset.notify-create-assets-success'), {
 *           count: successCount,
 *         });
 *   }
 * }
 *
 * @docsCategory providers
 * @docsPage NotificationService
 * @docsWeight 0
 */
export class NotificationService {
    constructor(i18nService, resolver, overlayHostService) {
        this.i18nService = i18nService;
        this.resolver = resolver;
        this.overlayHostService = overlayHostService;
        this.openToastRefs = [];
    }
    get hostView() {
        return this.overlayHostService.getHostView();
    }
    /**
     * @description
     * Display a success toast notification
     */
    success(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'success',
        });
    }
    /**
     * @description
     * Display an info toast notification
     */
    info(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'info',
        });
    }
    /**
     * @description
     * Display a warning toast notification
     */
    warning(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'warning',
        });
    }
    /**
     * @description
     * Display an error toast notification
     */
    error(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'error',
            duration: 20000,
        });
    }
    /**
     * @description
     * Display a toast notification.
     */
    notify(config) {
        this.createToast(config);
    }
    /**
     * Load a ToastComponent into the DOM host location.
     */
    createToast(config) {
        return __awaiter(this, void 0, void 0, function* () {
            const toastFactory = this.resolver.resolveComponentFactory(NotificationComponent);
            const hostView = yield this.hostView;
            const ref = hostView.createComponent(toastFactory);
            const toast = ref.instance;
            const dismissFn = this.createDismissFunction(ref);
            toast.type = config.type || 'info';
            toast.message = config.message;
            toast.translationVars = this.translateTranslationVars(config.translationVars || {});
            toast.registerOnClickFn(dismissFn);
            let timerId;
            if (!config.duration || 0 < config.duration) {
                timerId = setTimeout(dismissFn, config.duration || TOAST_DURATION);
            }
            this.openToastRefs.unshift({ ref, timerId });
            setTimeout(() => this.calculatePositions());
        });
    }
    /**
     * Returns a function which will destroy the toast component and
     * remove it from the openToastRefs array.
     */
    createDismissFunction(ref) {
        return () => {
            const toast = ref.instance;
            const index = this.openToastRefs.map(o => o.ref).indexOf(ref);
            if (this.openToastRefs[index]) {
                clearTimeout(this.openToastRefs[index].timerId);
            }
            toast.fadeOut().then(() => {
                ref.destroy();
                this.openToastRefs.splice(index, 1);
                this.calculatePositions();
            });
        };
    }
    /**
     * Calculate and set the top offsets for each of the open toasts.
     */
    calculatePositions() {
        let cumulativeHeight = 10;
        this.openToastRefs.forEach(obj => {
            const toast = obj.ref.instance;
            toast.offsetTop = cumulativeHeight;
            cumulativeHeight += toast.getHeight() + 6;
        });
    }
    translateTranslationVars(translationVars) {
        for (const [key, val] of Object.entries(translationVars)) {
            if (typeof val === 'string') {
                translationVars[key] = this.i18nService.translate(val);
            }
        }
        return translationVars;
    }
}
NotificationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NotificationService_Factory() { return new NotificationService(i0.ɵɵinject(i1.I18nService), i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i2.OverlayHostService)); }, token: NotificationService, providedIn: "root" });
NotificationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
NotificationService.ctorParameters = () => [
    { type: I18nService },
    { type: ComponentFactoryResolver },
    { type: OverlayHostService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9ub3RpZmljYXRpb24vbm90aWZpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSx3QkFBd0IsRUFBZ0IsVUFBVSxFQUFvQixNQUFNLGVBQWUsQ0FBQztBQUVyRyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxzREFBc0QsQ0FBQztBQUM3RixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7Ozs7QUF5QjFFLDZDQUE2QztBQUM3QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7QUFFNUI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBb0JHO0FBSUgsTUFBTSxPQUFPLG1CQUFtQjtJQU81QixZQUNZLFdBQXdCLEVBQ3hCLFFBQWtDLEVBQ2xDLGtCQUFzQztRQUZ0QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQUNsQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBTDFDLGtCQUFhLEdBQXNFLEVBQUUsQ0FBQztJQU0zRixDQUFDO0lBVkosSUFBWSxRQUFRO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFVRDs7O09BR0c7SUFDSCxPQUFPLENBQUMsT0FBZSxFQUFFLGVBQW9EO1FBQ3pFLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDUixPQUFPO1lBQ1AsZUFBZTtZQUNmLElBQUksRUFBRSxTQUFTO1NBQ2xCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFJLENBQUMsT0FBZSxFQUFFLGVBQW9EO1FBQ3RFLElBQUksQ0FB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a0IsRUFBRSxDQUFDO1lBQzlCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVEOztPQUVHO0lBQ0ssa0JBQWtCO1FBQ3RCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBRTFCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLE1BQU0sS0FBSyxHQUEwQixHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztZQUN0RCxLQUFLLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDO1lBQ25DLGdCQUFnQixJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sd0JBQXdCLENBQUMsZUFBbUQ7UUFHaEYsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDdEQsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7Z0JBQ3pCLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxRDtTQUNKO1FBQ0QsT0FBTyxlQUFlLENBQUM7SUFDM0IsQ0FBQzs7OztZQTNJSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7OztZQXBEUSxXQUFXO1lBSFgsd0JBQXdCO1lBSXhCLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBOb3RpZmljYXRpb25Db21wb25lbnQgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL25vdGlmaWNhdGlvbi9ub3RpZmljYXRpb24uY29tcG9uZW50JztcclxuaW1wb3J0IHsgSTE4blNlcnZpY2UgfSBmcm9tICcuLi9pMThuL2kxOG4uc2VydmljZSc7XHJcbmltcG9ydCB7IE92ZXJsYXlIb3N0U2VydmljZSB9IGZyb20gJy4uL292ZXJsYXktaG9zdC9vdmVybGF5LWhvc3Quc2VydmljZSc7XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIFRoZSB0eXBlcyBvZiBub3RpZmljYXRpb24gYXZhaWxhYmxlLlxyXG4gKlxyXG4gKiBAZG9jc0NhdGVnb3J5IHByb3ZpZGVyc1xyXG4gKiBAZG9jc1BhZ2UgTm90aWZpY2F0aW9uU2VydmljZVxyXG4gKi9cclxuZXhwb3J0IHR5cGUgTm90aWZpY2F0aW9uVHlwZSA9ICdpbmZvJyB8ICdzdWNjZXNzJyB8ICdlcnJvcicgfCAnd2FybmluZyc7XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIENvbmZpZ3VyYXRpb24gZm9yIGEgdG9hc3Qgbm90aWZpY2F0aW9uLlxyXG4gKlxyXG4gKiBAZG9jc0NhdGVnb3J5IHByb3ZpZGVyc1xyXG4gKiBAZG9jc1BhZ2UgTm90aWZpY2F0aW9uU2VydmljZVxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBUb2FzdENvbmZpZyB7XHJcbiAgICBtZXNzYWdlOiBzdHJpbmc7XHJcbiAgICB0cmFuc2xhdGlvblZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB9O1xyXG4gICAgdHlwZT86IE5vdGlmaWNhdGlvblR5cGU7XHJcbiAgICBkdXJhdGlvbj86IG51bWJlcjtcclxufVxyXG5cclxuLy8gSG93IG1hbnkgbXMgYmVmb3JlIHRoZSB0b2FzdCBpcyBkaXNtaXNzZWQuXHJcbmNvbnN0IFRPQVNUX0RVUkFUSU9OID0gMzAwMDtcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogUHJvdmlkZXMgdG9hc3Qgbm90aWZpY2F0aW9uIGZ1bmN0aW9uYWxpdHkuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYFR5cGVTY3JpcHRcclxuICogY2xhc3MgTXlDb21wb25lbnQge1xyXG4gKiAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZSkge31cclxuICpcclxuICogICBzYXZlKCkge1xyXG4gKiAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlXHJcbiAqICAgICAgICAgLnN1Y2Nlc3MoXygnYXNzZXQubm90aWZ5LWNyZWF0ZS1hc3NldHMtc3VjY2VzcycpLCB7XHJcbiAqICAgICAgICAgICBjb3VudDogc3VjY2Vzc0NvdW50LFxyXG4gKiAgICAgICAgIH0pO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKlxyXG4gKiBAZG9jc0NhdGVnb3J5IHByb3ZpZGVyc1xyXG4gKiBAZG9jc1BhZ2UgTm90aWZpY2F0aW9uU2VydmljZVxyXG4gKiBAZG9jc1dlaWdodCAwXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgZ2V0IGhvc3RWaWV3KCk6IFByb21pc2U8Vmlld0NvbnRhaW5lclJlZj4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm92ZXJsYXlIb3N0U2VydmljZS5nZXRIb3N0VmlldygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblRvYXN0UmVmczogQXJyYXk8eyByZWY6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+OyB0aW1lcklkOiBhbnkgfT4gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGkxOG5TZXJ2aWNlOiBJMThuU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBvdmVybGF5SG9zdFNlcnZpY2U6IE92ZXJsYXlIb3N0U2VydmljZSxcclxuICAgICkge31cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjcmlwdGlvblxyXG4gICAgICogRGlzcGxheSBhIHN1Y2Nlc3MgdG9hc3Qgbm90aWZpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIHN1Y2Nlc3MobWVzc2FnZTogc3RyaW5nLCB0cmFuc2xhdGlvblZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB9KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnkoe1xyXG4gICAgICAgICAgICBtZXNzYWdlLFxyXG4gICAgICAgICAgICB0cmFuc2xhdGlvblZhcnMsXHJcbiAgICAgICAgICAgIHR5cGU6ICdzdWNjZXNzJyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjcmlwdGlvblxyXG4gICAgICogRGlzcGxheSBhbiBpbmZvIHRvYXN0IG5vdGlmaWNhdGlvblxyXG4gICAgICovXHJcbiAgICBpbmZvKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnaW5mbycsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYSB3YXJuaW5nIHRvYXN0IG5vdGlmaWNhdGlvblxyXG4gICAgICovXHJcbiAgICB3YXJuaW5nKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnd2FybmluZycsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYW4gZXJyb3IgdG9hc3Qgbm90aWZpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnZXJyb3InLFxyXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMDAsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYSB0b2FzdCBub3RpZmljYXRpb24uXHJcbiAgICAgKi9cclxuICAgIG5vdGlmeShjb25maWc6IFRvYXN0Q29uZmlnKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVUb2FzdChjb25maWcpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTG9hZCBhIFRvYXN0Q29tcG9uZW50IGludG8gdGhlIERPTSBob3N0IGxvY2F0aW9uLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZVRvYXN0KGNvbmZpZzogVG9hc3RDb25maWcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCB0b2FzdEZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE5vdGlmaWNhdGlvbkNvbXBvbmVudCk7XHJcbiAgICAgICAgY29uc3QgaG9zdFZpZXcgPSBhd2FpdCB0aGlzLmhvc3RWaWV3O1xyXG4gICAgICAgIGNvbnN0IHJlZiA9IGhvc3RWaWV3LmNyZWF0ZUNvbXBvbmVudDxOb3RpZmljYXRpb25Db21wb25lbnQ+KHRvYXN0RmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgdG9hc3Q6IE5vdGlmaWNhdGlvbkNvbXBvbmVudCA9IHJlZi5pbnN0YW5jZTtcclxuICAgICAgICBjb25zdCBkaXNtaXNzRm4gPSB0aGlzLmNyZWF0ZURpc21pc3NGdW5jdGlvbihyZWYpO1xyXG4gICAgICAgIHRvYXN0LnR5cGUgPSBjb25maWcudHlwZSB8fCAnaW5mbyc7XHJcbiAgICAgICAgdG9hc3QubWVzc2FnZSA9IGNvbmZpZy5tZXNzYWdlO1xyXG4gICAgICAgIHRvYXN0LnRyYW5zbGF0aW9uVmFycyA9IHRoaXMudHJhbnNsYXRlVHJhbnNsYXRpb25WYXJzKGNvbmZpZy50cmFuc2xhdGlvblZhcnMgfHwge30pO1xyXG4gICAgICAgIHRvYXN0LnJlZ2lzdGVyT25DbGlja0ZuKGRpc21pc3NGbik7XHJcblxyXG4gICAgICAgIGxldCB0aW1lcklkO1xyXG4gICAgICAgIGlmICghY29uZmlnLmR1cmF0aW9uIHx8IDAgPCBjb25maWcuZHVyYXRpb24pIHtcclxuICAgICAgICAgICAgdGltZXJJZCA9IHNldFRpbWVvdXQoZGlzbWlzc0ZuLCBjb25maWcuZHVyYXRpb24gfHwgVE9BU1RfRFVSQVRJT04pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5vcGVuVG9hc3RSZWZzLnVuc2hpZnQoeyByZWYsIHRpbWVySWQgfSk7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmNhbGN1bGF0ZVBvc2l0aW9ucygpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB3aGljaCB3aWxsIGRlc3Ryb3kgdGhlIHRvYXN0IGNvbXBvbmVudCBhbmRcclxuICAgICAqIHJlbW92ZSBpdCBmcm9tIHRoZSBvcGVuVG9hc3RSZWZzIGFycmF5LlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGNyZWF0ZURpc21pc3NGdW5jdGlvbihyZWY6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+KTogKCkgPT4gdm9pZCB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9hc3Q6IE5vdGlmaWNhdGlvbkNvbXBvbmVudCA9IHJlZi5pbnN0YW5jZTtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLm9wZW5Ub2FzdFJlZnMubWFwKG8gPT4gby5yZWYpLmluZGV4T2YocmVmKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wZW5Ub2FzdFJlZnNbaW5kZXhdKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5vcGVuVG9hc3RSZWZzW2luZGV4XS50aW1lcklkKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdG9hc3QuZmFkZU91dCgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblRvYXN0UmVmcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVQb3NpdGlvbnMoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGN1bGF0ZSBhbmQgc2V0IHRoZSB0b3Agb2Zmc2V0cyBmb3IgZWFjaCBvZiB0aGUgb3BlbiB0b2FzdHMuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY2FsY3VsYXRlUG9zaXRpb25zKCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjdW11bGF0aXZlSGVpZ2h0ID0gMTA7XHJcblxyXG4gICAgICAgIHRoaXMub3BlblRvYXN0UmVmcy5mb3JFYWNoKG9iaiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvYXN0OiBOb3RpZmljYXRpb25Db21wb25lbnQgPSBvYmoucmVmLmluc3RhbmNlO1xyXG4gICAgICAgICAgICB0b2FzdC5vZmZzZXRUb3AgPSBjdW11bGF0aXZlSGVpZ2h0O1xyXG4gICAgICAgICAgICBjdW11bGF0aXZlSGVpZ2h0ICs9IHRvYXN0LmdldEhlaWdodCgpICsgNjtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVRyYW5zbGF0aW9uVmFycyh0cmFuc2xhdGlvblZhcnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIH0pOiB7XHJcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyO1xyXG4gICAgfSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKHRyYW5zbGF0aW9uVmFycykpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblZhcnNba2V5XSA9IHRoaXMuaTE4blNlcnZpY2UudHJhbnNsYXRlKHZhbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRyYW5zbGF0aW9uVmFycztcclxuICAgIH1cclxufVxyXG4iXX0=